document.addEventListener("DOMContentLoaded",function(){var e=[].slice.call(document.querySelectorAll("img.lazy")),t=[].slice.call(document.querySelectorAll(".lazy-background")),a=[].slice.call(document.querySelectorAll("[data-bg]"));if("IntersectionObserver"in window){let r=new IntersectionObserver(function(e,t){e.forEach(function(e){if(e.isIntersecting){let t=e.target;t.src=t.dataset.src,t.srcset=t.dataset.srcset,t.classList.remove("lazy"),r.unobserve(t)}})});e.forEach(function(e){r.observe(e)});let n=new IntersectionObserver(function(e,t){e.forEach(function(e){e.isIntersecting&&(e.target.classList.add("visible"),n.unobserve(e.target))})});t.forEach(function(e){n.observe(e)});let i=new IntersectionObserver(function(e,t){e.forEach(function(e){if(e.isIntersecting){let t=e.target;t.style.backgroundImage="url("+t.dataset.bg+")",i.unobserve(t)}})});a.forEach(function(e){i.observe(e)})}else e.forEach(function(e){e.src=e.dataset.src,e.srcset=e.dataset.srcset}),t.forEach(function(e){e.classList.add("visible")}),a.forEach(function(e){e.style.backgroundImage="url("+e.dataset.bg+")"})});let movies,searchFormSidebar=document.querySelector("#search-form"),searchFormHeader=document.querySelector(".search__form"),searchFormHamburger=document.querySelector(".aside-search__form"),genres=document.querySelectorAll(".sidebar__genres"),nav=document.querySelectorAll(".nav"),movie=document.querySelector("#movies"),urlPoster="https://image.tmdb.org/t/p/w500",explorer=document.querySelector(".explorer"),hamburger=document.querySelector(".button"),aside=document.querySelector(".aside"),hamburgerClose=document.querySelector(".aside-header__button");function closeAside(){aside.classList.remove("aside_active")}hamburger.addEventListener("click",()=>{aside.classList.add("aside_active")}),hamburgerClose.addEventListener("click",closeAside);let searchSidebar=document.querySelector("#searchText"),searchHeader=document.querySelector(".search__input"),searchHamburger=document.querySelector(".aside-search__input");searchFormSidebar.addEventListener("submit",()=>{apiSearch(event,searchSidebar)}),searchFormHeader.addEventListener("submit",()=>{apiSearch(event,searchHeader)}),searchFormHamburger.addEventListener("submit",()=>{apiSearch(event,searchHamburger)});let icon=document.querySelector(".search__icon"),search=document.querySelector(".search__input");icon.addEventListener("click",()=>{icon.classList.add("search__icon_active"),search.classList.add("search__input_active")}),search.addEventListener("blur",()=>{icon.classList.remove("search__icon_active"),search.classList.remove("search__input_active")});let popular=document.querySelectorAll(".nav__item_popular"),upcoming=document.querySelectorAll(".nav__item_upcoming"),topMovies=document.querySelectorAll(".nav__item_movie-top"),topTv=document.querySelectorAll(".nav__item_tv-top"),trendingKey="https://api.themoviedb.org/3/trending/all/week?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru",upcomingKey="https://api.themoviedb.org/3/movie/upcoming?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru&page=1",topMoviesKey="https://api.themoviedb.org/3/movie/top_rated?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru&page=1",topTvKey="https://api.themoviedb.org/3/tv/top_rated?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru&page=1";function getContent(e,t){fetch(e).then(function(e){return 200!==e.status?Promise.reject():e.json()}).then(function(e){let a=`<h4 class="col-12 grid-title">${t}</h4>`;0===e.results.length&&(a='<h2 class="col-12 text-center text-info">По вашему запросу ничего не найдено</h2>'),e.results.forEach(function(e){let t=e.name||e.title,r=e.title?"movie":"tv",n=e.poster_path?urlPoster+e.poster_path:"./img/noposter.png",i=e.first_air_date||e.release_date;newDate=i.split("-").join(" | ");let s=`data-id="${e.id}" data-type="${r}"`;a+=`<div class="col-12 col-md-4 col-xl-3 item"  data-genre="${e.genre_ids}">\n          <img src="${n}" class="item__poster img-responsive" alt="${t}" ${s}>\n          <h5 class="item__title">${t}</h5>\n          <h5 class="item__date">${newDate}</h5>\n          </div>`}),movie.innerHTML=a,addEventMedia()}).then(()=>{movies=document.querySelectorAll(".item")}).catch(function(e){movie.innerHTML="Упс, что-то пошло не так!",console.log("error:"+e)}),closeAside()}function apiSearch(e,t){e.preventDefault();let a=t.value.trim();0===a.length&&(movie.innerHTML='<h2 class="col-12 text-center text-danger">Поле поиска не должно быть пустым</h2>'),movie.innerHTML='<div class="spinner"></div>',fetch("https://api.themoviedb.org/3/search/multi?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru&query=%27"+a).then(function(e){return 200!==e.status?Promise.reject():e.json()}).then(function(e){let r=`<h4 class="col-12 grid-title">Результаты по запросу "${a}"</h4>`;0===e.results.length&&(r='<h2 class="col-12 text-center grid-title">По вашему запросу ничего не найдено</h2>'),e.results.forEach(function(e){let t=e.name||e.title,a=e.poster_path?urlPoster+e.poster_path:"./img/noposter.png",n=(e.first_air_date||e.release_date).split("-").join(" | "),i="";"person"!==e.media_type&&(i=`data-id="${e.id}" data-type="${e.media_type}"`),r+=`<div class="col-12 col-md-4 col-xl-3 item"  data-genre="${e.genre_ids}">\n\t\t\t\t<img src="${a}" class="item__poster img-responsive" alt="${t}" ${i}>\n        <h5 class="item__title">${t}</h5>\n        <h4 class="item__date">${n}</h4>\n        </div>`}),movie.innerHTML=r,addEventMedia(),icon.classList.remove("search__icon_active"),t.classList.remove("search__input_active")}).then(()=>{movies=document.querySelectorAll(".item")}).then(()=>{render()}).catch(function(e){movie.innerHTML="Упс, что-то пошло не так!",console.log("error:"+e)}),closeAside()}function addEventMedia(){movie.querySelectorAll("img[data-id]").forEach(function(e){e.style.cursor="pointer",e.addEventListener("click",showFullInfo)})}function showFullInfo(){let e="";"movie"===this.dataset.type?e=`https://api.themoviedb.org/3/movie/${this.dataset.id}?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru`:"tv"===this.dataset.type?e=`https://api.themoviedb.org/3/tv/${this.dataset.id}?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru`:movie.innerHTML="Упс, что-то пошло не так!",typeMedia=this.dataset.type,idMedia=this.dataset.id,fetch(e).then(function(e){return 200!==e.status?Promise.reject():e.json()}).then(function(e){explorer.classList.add("container"),explorer.innerHTML=`<h4 class="col-12 text-center text-info head-title head-title_accent ">${e.name||e.title}</h4>\n      <div class="row about">\n          <div class="col-md-6 col-sm-12 about__keyart">\n          <img class="img-responsive about__poster" src='${urlPoster+e.poster_path}' alt="${e.name||e.title}">\n          </div>\n          <div class="col-md-6 col-sm-12 about__info">\n          <h3 class="about__title">${e.name||e.title}</h3>\n          <p class="about__date">${e.first_air_date||e.release_date} ${"| "+e.genres[0].name||""}</p>\n          <p class="about__rate">Рейтинг: ${e.vote_average}</p>\n          ${e.last_episode_to_air?`<p>Сезонов: ${e.number_of_seasons}<br>Ceрий: ${e.last_episode_to_air.episode_number}</p>`:""}\n          <p>${e.overview}</p>\n          <div class="youtube"></div>\n          <div class="about__links">\n          ${e.homepage?`<a class="about__link" href="${e.homepage}" target="_blank">Официальная страница</a>`:""} \n          ${e.imdb_id?`<a class="about__link" href="https://imdb.com/title/${e.imdb_id}" target="_blank">Страница на IMDB.com</a>`:""}\n          </div>\n          </div>\n        </div>`,getVideo(typeMedia,idMedia)}).catch(function(){movie.innerHTML="Упс, что-то пошло не так!",console.log("error")}),icon.style.display="none",nav.forEach(e=>{e.style.display="none"}),hamburger.style.display="none"}function getVideo(e,t){let a=document.querySelector(".youtube");fetch(`https://api.themoviedb.org/3/${e}/${t}/videos?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru`).then(e=>200!==e.status?Promise.reject():e.json()).then(e=>{let t='<h5 class="col-12">Трейлер</h5>';t+=`<iframe width="560" height="315" src="https://www.youtube.com/embed/${e.results[0].key}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`,a.innerHTML=t}).catch(function(e){a.innerHTML=" ",console.log("error:"+e)})}function getGenres(){fetch("https://api.themoviedb.org/3/genre/movie/list?api_key=d1777f7d2dcd8568a3d1a207d0b05303&language=ru").then(e=>200!==e.status?Promise.reject():e.json()).then(e=>{genres.forEach(t=>{e.genres.forEach(e=>{t.innerHTML+=`<li class="genres__item sidebar__genre"><input type="checkbox" class="sidebar__check" data-id="${e.id}"><span class="genres__faux sidebar__faux"></span><span class="genres__text sidebar__text">${e.name}</span></li>`})})}).then(()=>{render()}).catch(function(e){movie.innerHTML=" ",console.log("error:"+e)})}function render(){let e=document.querySelectorAll("input.sidebar__check"),t=[];e.forEach(e=>{e.addEventListener("click",()=>{sortByGenres(e.getAttribute("data-id"),movies,t)})})}function sortByGenres(e,t,a){t.forEach((t,r)=>{let n=t.getAttribute("data-genre").split(",");for(let i=0;i<n.length;i++){if(n[i]!==e){t.style.display="none",a.splice(r,1);break}a.push(t);break}}),a.forEach(e=>{e.style.display="block"})}document.addEventListener("DOMContentLoaded",()=>{getGenres(),getContent(trendingKey,"Популярное за неделю")}),popular.forEach(e=>{e.addEventListener("click",()=>{getContent(trendingKey,"Популярное за неделю")})}),upcoming.forEach(e=>{e.addEventListener("click",()=>{getContent(upcomingKey,"Новинки")})}),topMovies.forEach(e=>{e.addEventListener("click",()=>{getContent(topMoviesKey,"Лучшие фильмы")})}),topTv.forEach(e=>{e.addEventListener("click",()=>{getContent(topTvKey,"Лучшие сериалы")})});